const crypto = require('./src')
const {TextEncoder, TextDecoder} = require('text-encoding')

let key

let params = {
  name: 'HMAC',
  hash: { name: 'SHA-256' }
}

let data = new TextEncoder().encode('foo')

// generate RSA keypair
crypto
  .subtle
  .generateKey(params, true, ['sign', 'verify'])
  .then(result => {
    key = result
    console.log(key, key.handle)
  })

  // sign some data
  .then(() => {
    return crypto.subtle.sign(params, key, data)
  })

  // verify signature
  .then(signature => {
    console.log('signature', new TextDecoder().decode(signature))//signature)//, ab2str(signature))
    return crypto.subtle.verify(params, key, signature, data)
  })

  // it worked!
  .then(verified => console.log('verified:', verified))
  .then(() => {
    return crypto.subtle.exportKey('jwk', key)
  })
  .then(jwk => {
    return crypto.subtle.importKey('jwk', jwk, { name: 'HMAC', hash: { name: 'SHA-256' } }, true, ['sign', 'verify'])
  })
  .then(ckey => {
    console.log(ckey, ckey.handle)
  })

  // it failed
  .catch(err => console.log(err))
